# Documentation: Filtering NLST data, then generating ROC curves and confusion matrices based on Sybil predictions

*Last updated 12/04/2023 by Abdul Zakkar*

Find the Python script `sybil_eval.py` [here](../scripts/sybil_eval.py).

## Usage

`usage: sybil_eval.py [-h] [-o OUTDIR] [-f FILTERS [FILTERS ...]] [-c CUTOFFS
[CUTOFFS ...]] actual prediction`

### Positional arguments:

| Argument | Description |
|---|---|
| actual | A CSV file generated by nlst_actual.py which contains the actual values regarding the presence of cancer n years after a given CT scan. |
| prediction | A CSV file generated by main.py (utilized by Sybil container image) which contains the prediction values generated by Sybil regarding the
probability of cancer n years after a given CT scan. |

### Optional arguments:

| Shortened identifier | Identifier | Description | Default |
|---|---|---|---|
| -o OUTDIR | --outdir OUTDIR | A directory in which to generate the output. | Script current working directory. |
| -f [FILTERS ...] | --filters [FILTERS ...] | Any number of filters to apply to the data, formated as such: property_name:value:operator, e.g. race:2:e. Operator options: e -> equal, g -> greater than, l -> less than, ge -> greater than or equal to, le -> less than or equal to. | No filters. |
| -c [CUTOFFS ...] | --cutoffs [CUTOFFS ...] | Any number of probability cutoffs to be used for the generation of multiple confusion matrices. | 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9 |

### Example Usage

`sybil_nlst_filter_for_roc.py path/to/actual.csv path/to/prediction.csv -o output_dir -f gender:2:e race:2:e -c 0.25 0.5 0.75`

### More about the arguments

- Sybil predictions- A CSV file with the format described [here](doc_sybil_main_py.md).
- NLST Actual- A CSV file with the format described [here](doc_nlst_actual.md).

## Description

- This is the last script in the pipeline to evaluate the performance of the Sybil CNN model on NLST CT Chest DICOMs.
- Please see documentation about how to generate the positional arguments: `actual` and `prediction`.
    - Documentation for generating `actual` found [here](doc_nlst_actual.md).
    - Documentation for generating `prediction` found [here](doc_sybil_main_py.md).
- This script accepts user arguments for filters on NLST data (i.e. `actual`), using any number of the following properties:
    - Patient ID (PID).
    - Study Year 0 to 2. 
    - Gender.
    - Race.
    - Sybil Data Split (Training, Development, Testing, Never seen).
    - Presence of cancer N number of years after the CT scan.
    - Number of days between CT scan event and day of diagnosis with lung cancer.
- Use the link above for `actual` for further description of these properties.
- The results of this script are represented as Receiver Operating Characteristic (ROC) curves and confusion matrices. See below.

## Outputs

- A directory will be created and named based on the chosen filters.
- This directory will include the following:
    - A PNG of the multi-ROC curve, each curve labeled by prediction year and Area Under Curve (AUC) value.
    - Multiple CSV files, each representing a prediction year (year 1 to 6).
        - Each CSV file contains multiple confusion matrices, one for each
          probability cutoff.
        - Additional information is provided: Sensitivity, specificity,
          accuracy, positive predictive value, and negative predictive value.
